# 完整用户画像生成系统

## 概述

这个系统整合了原有的 `generate_attribute.py` 和 `generate_profile.py` 的功能，提供了一个统一的、规范的用户画像生成解决方案。系统会从对话数据中提取用户属性，并生成完整的用户画像，所有结果保存为统一的JSONL格式。

## 主要特性

- **统一处理流程**: 一次性完成属性提取和画像生成
- **规范的数据格式**: 输出统一的JSONL格式，包含原始对话、中间属性和最终画像
- **并行处理**: 支持多线程并行处理，提高效率
- **错误处理**: 完善的异常处理和状态跟踪
- **进度显示**: 实时显示处理进度
- **统计信息**: 处理完成后显示详细统计信息

## 输出格式

每条记录包含以下字段：

```json
{
  "id": 0,                           // 记录ID
  "original_dialog": [...],          // 原始对话数据
  "user_messages": "...",            // 提取的用户消息字符串
  "attributes": {                    // 生成的属性
    "character": "...",              // 知识特征
    "persona": "...",                // 性格特征  
    "scene": "..."                   // 场景特征
  },
  "profile": "...",                  // 最终生成的用户画像
  "status": "success"                // 处理状态
}
```

## 状态说明

- `success`: 成功生成完整画像
- `insufficient_attributes`: 属性不足，无法生成画像
- `profile_generation_failed`: 最终画像生成失败
- `error`: 处理过程中出现错误

## 使用方法

### 基本使用

```bash
python generate_complete_profile.py \
    --input_file "input.jsonl" \
    --output_file "output.jsonl" \
    --max_count 1000 \
    --num_workers 16
```

### 参数说明

| 参数 | 必需 | 默认值 | 说明 |
|------|------|--------|------|
| `--input_file` | 是 | - | 输入的JSONL文件路径 |
| `--output_file` | 是 | - | 输出的JSONL文件路径 |
| `--max_count` | 否 | None | 最大处理数量，默认处理全部 |
| `--num_workers` | 否 | 16 | 并行工作线程数 |
| `--start_idx` | 否 | 0 | 起始索引 |
| `--show_examples` | 否 | 3 | 显示示例数量 |

### 快速开始

1. **准备输入数据**: 确保输入文件是JSONL格式，每行包含一个对话数据
2. **运行脚本**: 使用提供的示例脚本
   ```bash
   chmod +x run_complete_profile.sh
   ./run_complete_profile.sh
   ```
3. **查看结果**: 检查输出文件和统计信息

## 性能优化建议

1. **线程数设置**: 
   - CPU密集型任务建议设置为CPU核心数
   - IO密集型任务可以设置为CPU核心数的2-4倍
   - 默认16线程适合大多数情况

2. **批量处理**:
   - 对于大数据集，建议分批处理
   - 使用 `--max_count` 和 `--start_idx` 参数

3. **错误处理**:
   - 检查失败的记录，分析失败原因
   - 可以单独重新处理失败的记录

## 与原代码的差异

### 主要改进

1. **代码结构**: 使用面向对象设计，代码更加模块化
2. **数据格式**: 统一的JSONL输出格式，包含完整信息
3. **错误处理**: 更加完善的异常处理机制
4. **进度跟踪**: 实时进度显示和状态管理
5. **参数管理**: 统一的参数解析和配置管理

### 兼容性

- 保持与原有 `config.py` 和 `chatgpt_helper` 的兼容性
- 输入数据格式与原代码兼容
- prompt配置与原代码兼容

## 故障排除

### 常见问题

1. **GPT API调用失败**: 检查API配置和网络连接
2. **内存不足**: 减少 `num_workers` 参数
3. **文件权限错误**: 确保输出目录有写入权限
4. **输入格式错误**: 检查输入JSONL文件格式

### 调试建议

1. **小批量测试**: 先用 `--max_count 10` 测试
2. **查看日志**: 注意控制台输出的警告和错误信息
3. **检查状态**: 分析输出文件中的 `status` 字段

## 扩展功能

系统设计支持以下扩展：

1. **新增属性类型**: 在 `generate_attribute` 方法中添加新的属性类型
2. **自定义输出格式**: 修改 `process_single_dialog` 方法
3. **不同的合并策略**: 修改 `generate_profile` 方法
4. **数据验证**: 添加输入数据验证逻辑

## 许可证

与原项目保持一致。 